<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>√âditeur de Livre Digital</title>
  <link href="/quill/quill.snow.css" rel="stylesheet">
  <style>
    :root {
      /* Couleurs fixes pour l'√©diteur */
      --primary-color: #2c3e50;
      --secondary-color: #3498db;
      --tertiary-color: #ecf0f1;
      --primary-light: #34495e;
      --secondary-light: #5dade2;
      --tertiary-dark: #bdc3c7;
      --font-primary: 'Poppins', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
    }

    body {
      font-family: var(--font-primary);
      background: linear-gradient(135deg, var(--tertiary-color) 0%, #e8eff2 100%);
      margin: 0;
      padding: 20px;
      color: var(--primary-color);
    }

    .header-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      background: white;
      padding: 1rem;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .header-bar h1 {
      margin: 0;
      color: var(--primary-color);
    }

    .logout-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
    }

    .logout-btn:hover {
      background: #c82333;
    }

    /* Syst√®me d'onglets */
    .tabs-container {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      margin-bottom: 1rem;
    }

    .tabs-header {
      display: flex;
      border-bottom: 1px solid var(--tertiary-color);
    }

    .tab-button {
      background: none;
      border: none;
      padding: 1rem 2rem;
      cursor: pointer;
      font-size: 1rem;
      color: var(--primary-color);
      border-bottom: 3px solid transparent;
      transition: all 0.3s ease;
    }

    .tab-button:hover {
      background: var(--tertiary-color);
    }

    .tab-button.active {
      color: var(--secondary-color);
      border-bottom-color: var(--secondary-color);
      background: #f9f9f9;
    }

    .tab-content {
      padding: 2rem;
      min-height: 70vh;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* Styles pour l'onglet Pages */
    .pages-editor {
      display: flex;
      gap: 2rem;
    }

    .pages-form {
      flex: 1 1 60%;
    }

    .pages-help {
      flex: 1 1 40%;
      background: #f9f9f9;
      padding: 1rem;
      border-radius: 8px;
      max-height: 70vh;
      overflow-y: auto;
    }

  textarea {
    width: 100%;
    height: 400px;
    box-sizing: border-box;
    padding: 1rem;
    border: 1px solid var(--tertiary-dark);
    border-radius: 8px;
    font-family: var(--font-primary);
    resize: vertical;
  }

  /* Quill editor */
  #toolbar {
    border: 1px solid var(--tertiary-dark);
    border-radius: 8px 8px 0 0;
    background: white;
  }

  #pageEditor {
    height: 400px;
    border: 1px solid var(--tertiary-dark);
    border-top: none;
    border-radius: 0 0 8px 8px;
  }

    input[type="text"] {
      width: 100%;
      box-sizing: border-box;
      padding: 0.5rem;
      margin: 0.3rem 0;
      border: 1px solid var(--tertiary-dark);
      border-radius: 6px;
      font-family: var(--font-primary);
    }

    .nav-buttons {
      text-align: center;
      margin: 1rem 0;
    }

    .nav-buttons button {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 6px;
      margin: 0 0.5rem;
      cursor: pointer;
      transition: background 0.3s ease;
    }

    .nav-buttons button:hover {
      background: var(--primary-light);
    }

    .nav-buttons button:disabled {
      background: var(--tertiary-color);
      color: var(--tertiary-dark);
      cursor: not-allowed;
    }

    /* Styles pour l'onglet Th√®me */
    .theme-editor {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2rem;
    }

    .theme-form {
      background: #f9f9f9;
      padding: 1.5rem;
      border-radius: 8px;
    }

    .theme-preview {
      background: white;
      padding: 1.5rem;
      border-radius: 8px;
      border: 1px solid var(--tertiary-dark);
    }

    .form-group {
      margin-bottom: 1rem;
    }

    .form-group label {
      display: block;
      margin-bottom: 0.5rem;
      font-weight: 500;
      color: var(--primary-color);
    }

    .form-group input[type="color"] {
      width: 100%;
      height: 40px;
      border: 1px solid var(--tertiary-dark);
      border-radius: 6px;
      cursor: pointer;
    }

    .form-group select {
      width: 100%;
      padding: 0.5rem;
      border: 1px solid var(--tertiary-dark);
      border-radius: 6px;
      font-family: var(--font-primary);
    }

    .color-preview {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.25rem;
    }

    .color-swatch {
      width: 20px;
      height: 20px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    .btn-primary {
      background: var(--primary-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }

    .btn-primary:hover {
      background: var(--primary-light);
    }

    .btn-secondary {
      background: var(--secondary-color);
      color: white;
      border: none;
      padding: 0.75rem 1.5rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s ease;
    }

    .btn-secondary:hover {
      background: var(--secondary-light);
    }

    .delete-btn {
      background: #dc3545;
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s ease;
      margin-left: 0.5rem;
    }

    .delete-btn:hover:not(:disabled) {
      background: #c82333;
    }

    .delete-btn:disabled {
      background: #6c757d;
      cursor: not-allowed;
      opacity: 0.6;
    }

    .notice {
      color: var(--secondary-color);
      font-size: 0.9rem;
      margin: 0.2rem 0 0.6rem;
    }

    .success-message {
      background: #d4edda;
      color: #155724;
      padding: 0.75rem;
      border-radius: 6px;
      margin-bottom: 1rem;
      display: none;
    }

    /* Styles pour les sections de th√®me */
    .theme-sections {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 1px solid var(--tertiary-dark);
    }

    .theme-section-btn {
      background: transparent;
      border: none;
      padding: 0.75rem 1rem;
      cursor: pointer;
      font-family: var(--font-primary);
      font-size: 0.9rem;
      color: var(--primary-light);
      border-bottom: 2px solid transparent;
      transition: all 0.3s ease;
    }

    .theme-section-btn:hover {
      color: var(--primary-color);
      background: var(--tertiary-color);
    }

    .theme-section-btn.active {
      color: var(--secondary-color);
      border-bottom-color: var(--secondary-color);
      font-weight: 600;
    }

    .theme-section {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .theme-section.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .theme-options {
      margin-top: 1rem;
      padding: 1rem;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid var(--secondary-color);
    }

    .theme-section h3 {
      color: var(--primary-color);
      margin-bottom: 1rem;
      font-size: 1.1rem;
      border-bottom: 1px solid var(--tertiary-dark);
      padding-bottom: 0.5rem;
    }

    /* Aper√ßu du th√®me */
    .theme-preview-content {
      font-family: var(--font-primary);
    }

    .preview-title {
      color: var(--primary-color);
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
    }

    .preview-subtitle {
      color: var(--primary-light);
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .preview-accent {
      color: var(--secondary-color);
      font-weight: bold;
    }

    .preview-background {
      background: var(--tertiary-color);
      padding: 1rem;
      border-radius: 6px;
      margin: 1rem 0;
    }

    .preview-card {
      background: white;
      padding: 1rem;
      border-radius: 6px;
      border-left: 4px solid var(--secondary-color);
    }

    /* Nouveaux styles pour l'aper√ßu simplifi√© */
    .preview-cover-background {
      background: var(--cover-end-background-color, #d8e0e5);
      padding: 1.5rem;
      border-radius: 8px;
      margin-bottom: 1rem;
      text-align: center;
    }

    .preview-content-page {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .preview-content-title {
      color: #333;
      font-size: 1.2rem;
      margin: 0 0 0.5rem 0;
      font-weight: 600;
    }

    .preview-separator {
      height: 2px;
      background: var(--separator-color, #638c1c);
      margin: 0.5rem 0 1rem 0;
      border-radius: 1px;
    }

    .preview-cover-title-section {
      background: var(--cover-end-background-color, #d8e0e5);
      padding: 1rem;
      border-radius: 8px;
      margin-top: 1rem;
    }

    .preview-cover-title {
      color: #333;
      font-size: 1.2rem;
      margin: 0 0 0.5rem 0;
      font-weight: 600;
    }

    .preview-cover-separator {
      height: 2px;
      background: var(--cover-end-separator-color, #ffffff);
      margin: 0.5rem 0 1rem 0;
      border-radius: 1px;
    }

    /* Styles pour l'onglet M√©dias */
    .media-upload-area {
      border: 2px dashed var(--tertiary-dark);
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      background: #fafafa;
      margin-bottom: 2rem;
      transition: all 0.3s ease;
    }

    .media-upload-area:hover {
      border-color: var(--secondary-color);
      background: #f0f8ff;
    }

    .media-upload-area.dragover {
      border-color: var(--secondary-color);
      background: var(--secondary-light);
      opacity: 0.1;
    }

    .upload-icon {
      font-size: 3rem;
      color: var(--tertiary-dark);
      margin-bottom: 1rem;
    }

    .media-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }

    .media-item {
      background: white;
      border-radius: 8px;
      padding: 1rem;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      border: 1px solid var(--tertiary-color);
      transition: all 0.3s ease;
    }

    .media-item:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .media-preview {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 6px;
      background: var(--tertiary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 0.5rem;
    }

    .media-preview img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 6px;
    }

    .media-preview .video-icon {
      font-size: 3rem;
      color: var(--primary-color);
    }

    .video-preview {
      position: relative;
      width: 100%;
      height: 100%;
      background: var(--tertiary-color);
      border-radius: 6px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-preview video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      pointer-events: none; /* Emp√™che la lecture automatique */
    }

    .video-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 2rem;
      color: white;
      background: rgba(0, 0, 0, 0.6);
      padding: 0.5rem;
      border-radius: 50%;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .media-info {
      padding: 0.5rem 0;
    }

    .media-filename {
      font-weight: 600;
      color: var(--primary-color);
      margin-bottom: 0.25rem;
      font-size: 0.9rem;
    }

    .media-original {
      color: var(--primary-light);
      font-size: 0.8rem;
      margin-bottom: 0.5rem;
    }

    .media-syntax {
      background: var(--tertiary-color);
      padding: 0.5rem;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.8rem;
      color: var(--primary-color);
      cursor: pointer;
      transition: background 0.3s ease;
    }


    .media-syntax:hover {
      background: var(--tertiary-dark);
    }

    .media-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 0.5rem;
    }

    .action-btn {
      padding: 0.3rem 0.6rem;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.8rem;
      transition: all 0.3s ease;
    }

    .copy-btn {
      background: var(--secondary-color);
      color: white;
    }

    .copy-btn:hover {
      background: var(--secondary-light);
    }

    .delete-btn {
      background: #dc3545;
      color: white;
    }

    .delete-btn:hover {
      background: #c82333;
    }

    .media-stats {
      background: white;
      padding: 1rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1rem;
      text-align: center;
    }

    .stat-item {
      padding: 0.5rem;
    }

    .stat-value {
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--secondary-color);
    }

    .stat-label {
      font-size: 0.8rem;
      color: var(--primary-light);
      margin-top: 0.25rem;
    }

    @media (max-width: 768px) {
      .theme-editor {
        grid-template-columns: 1fr;
      }
      
      .pages-editor {
        flex-direction: column;
      }

      .media-grid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
      }
    }

    /* Styles pour la modal des m√©dias */
    .media-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }

    .media-modal-content {
      background: white;
      border-radius: 8px;
      max-width: 90vw;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }

    .media-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--tertiary-color);
      background: var(--tertiary-color);
    }

    .media-modal-header h3 {
      margin: 0;
      color: var(--primary-color);
    }

    .media-modal-header button {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      padding: 0.5rem;
      border-radius: 4px;
      transition: background 0.3s ease;
    }

    .media-modal-header button:hover {
      background: rgba(0, 0, 0, 0.1);
    }

    .media-modal-body {
      padding: 1rem;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .media-modal-body img,
    .media-modal-body video {
      max-width: 100%;
      max-height: 70vh;
      object-fit: contain;
    }

    /* Styles pour les m√©dias vides */
    .media-empty {
      text-align: center;
      padding: 3rem;
      color: var(--tertiary-dark);
      font-style: italic;
      grid-column: 1 / -1;
    }
  </style>
</head>
<body>
  <div class="header-bar">
    <div>
      <h1>üìñ √âditeur de Livre Digital</h1>
      <a href="/books-manager" style="color: var(--secondary-color); text-decoration: none; font-size: 0.9rem;">‚Üê Retour √† mes livres</a>
    </div>
    <button class="logout-btn" onclick="logout()">üö™ Se d√©connecter</button>
  </div>

  <div class="tabs-container">
    <div class="tabs-header">
      <button class="tab-button active" onclick="switchTab('info')">üìö Informations</button>
      <button class="tab-button" onclick="switchTab('pages')">üìÑ Pages</button>
      <button class="tab-button" onclick="switchTab('media')">üé¨ M√©dias</button>
      <button class="tab-button" onclick="switchTab('theme')">üé® Th√®me</button>
      <button class="tab-button" onclick="switchTab('settings')">‚öôÔ∏è Param√®tres</button>
    </div>

    <div class="tab-content">
      <!-- Onglet Informations -->
      <div id="info-panel" class="tab-panel active">
        <h2>üìö Informations g√©n√©rales du livre</h2>
        <div id="infoSuccessMessage" class="success-message">
          Informations mises √† jour avec succ√®s !
        </div>
        
        <form id="infoForm">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">
            <div>
              <div class="form-group">
                <label for="bookTitle">Titre du livre *</label>
                <input type="text" id="bookTitle" name="title" required>
              </div>

              <div class="form-group">
                <label for="bookSubtitle">Sous-titre</label>
                <input type="text" id="bookSubtitle" name="subtitle">
              </div>

              <div class="form-group">
                <label for="bookInstitution">Institution/Organisation</label>
                <input type="text" id="bookInstitution" name="institution">
              </div>

              <div class="form-group">
                <label for="bookAuthor">Auteur</label>
                <input type="text" id="bookAuthor" name="author">
              </div>
            </div>

            <div>
              <div class="form-group">
                <label for="bookYears">Ann√©es</label>
                <input type="text" id="bookYears" name="years" placeholder="ex: 2020 - 2024">
              </div>

              <div class="form-group">
                <label for="bookAnniversary">Anniversaire</label>
                <input type="text" id="bookAnniversary" name="anniversary" placeholder="ex: 65 ans d'histoire">
              </div>

              <div class="form-group">
                <label for="bookCoverImage">Image de couverture</label>
                <input type="text" id="bookCoverImage" name="cover_image" placeholder="ex: media/couverture.jpg">
              </div>

              <div class="form-group">
                <label for="bookDescription">Description</label>
                <textarea id="bookDescription" name="description" rows="3" style="height: auto; min-height: 80px; resize: vertical;"></textarea>
              </div>

              <div class="form-group">
                <label for="bookLanguage">Langue du livre</label>
                <select id="bookLanguage" name="language" style="width: 100%; padding: 0.5rem; margin: 0.3rem 0; border: 1px solid var(--tertiary-dark); border-radius: 6px; font-family: var(--font-primary);">
                  <option value="fr">Fran√ßais (LTR)</option>
                  <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ© (RTL)</option>
                </select>
                <small style="color: #666; font-size: 0.9em;">
                  üìå L'arabe inverse l'ordre des pages et la direction de lecture (droite vers gauche)
                </small>
              </div>
            </div>
          </div>

          <div style="margin-top: 2rem;">
            <button type="submit" class="btn-primary">üíæ Sauvegarder les informations</button>
            <button type="button" class="btn-secondary" onclick="loadBookInfo()">üîÑ Actualiser</button>
          </div>
        </form>
      </div>

      <!-- Onglet Pages -->
      <div id="pages-panel" class="tab-panel">
        <div class="pages-editor">
          <form id="editorForm" method="POST" enctype="multipart/form-data" class="pages-form">
            <p><label>Page&nbsp;ID : <input id="pageId" type="text" readonly style="background-color: #f5f5f5; color: #666;"></label></p>
            <p><label>Type : 
              <select id="pageType" disabled style="background-color: #f5f5f5; color: #666;">
                <option value="content">CONTENT</option>
                <option value="sommaire">SOMMAIRE</option>
              </select>
            </label></p>
            <p><label>Titre : <input id="pageTitle" type="text" style="background-color: white; color: black;"></label></p>
            <p class="notice">ID et type sont automatiques. Le titre peut √™tre modifi√© pour appara√Ætre dans le sommaire.</p>
            <div id="toolbar">
              <span class="ql-formats">
                <select class="ql-header">
                  <option selected>Normal</option>
                  <option value="1">Titre H1</option>
                  <option value="2">Titre H2</option>
                  <option value="3">Titre H3</option>
                </select>
              </span>
              <span class="ql-formats">
                <select class="ql-font"></select>
                <select class="ql-size"></select>
              </span>
              <span class="ql-formats">
                <button class="ql-bold"></button>
                <button class="ql-italic"></button>
                <button class="ql-underline"></button>
                <button class="ql-link"></button>
              </span>
              <span class="ql-formats">
                <select class="ql-color"></select>
                <select class="ql-background"></select>
              </span>
              <span class="ql-formats">
                <button class="ql-list" value="ordered"></button>
                <button class="ql-list" value="bullet"></button>
              </span>
              <span class="ql-formats">
                <select class="ql-align"></select>
                <button class="ql-direction" value="rtl"></button>
              </span>
              <span class="ql-formats">
                <button class="ql-clean"></button>
              </span>
            </div>
            <div id="pageEditor"></div>
            <div class="nav-buttons">
              <button type="button" id="prevBtn">&larr;</button>
              <span id="pageNumber"></span>
              <button type="button" id="nextBtn">&rarr;</button>
              <button type="button" id="addBtn">Ajouter</button>
              <button type="button" id="deleteBtn" class="delete-btn">Supprimer</button>
              <button type="button" id="saveBtn" class="save-btn" style="background: #28a745; color: white;">üíæ Sauvegarder</button>
            </div>
            <p>Utilisez les fl√®ches pour parcourir les pages.</p>
            <input type="hidden" id="pageCount" name="pageCount" value="0">
            <div id="uploadSuccessMessage" class="success-message" style="display: none;">
              M√©dias upload√©s avec succ√®s !
            </div>
            <p>
              <em>üí° Utilisez l'onglet "üé¨ M√©dias" pour g√©rer vos images et vid√©os</em>
            </p>
            
            <button type="submit" class="btn-primary">Enregistrer</button>
            <button type="button" id="buildBtn" class="btn-secondary">G√©n√©rer</button>
            <button type="button" id="viewBtn" class="btn-secondary">Visualiser</button>
          </form>

          <div class="pages-help">
            <h2>üìù Guide de l'√©diteur HTML</h2>
            <p>L'identifiant, le type et le titre sont g√©r√©s automatiquement.</p>
            <p>Utilisez l'√©diteur visuel (Quill) pour formater votre contenu.</p>
            
            <h3>üé® Formatage de base</h3>
            <h4>Titres</h4>
            <p>Utilisez le menu d√©roulant de titres dans la barre d'outils :</p>
            <ul>
              <li><strong>H1</strong> : Titre principal de page (avec trait vert dessous)</li>
              <li><strong>H2</strong> : Sous-titre important</li>
              <li><strong>H3</strong> : Section</li>
              <li><strong>Normal</strong> : Texte normal</li>
            </ul>
            <p><em>‚ö†Ô∏è Note : "Huge" dans taille = juste texte plus grand. Pour de vrais titres avec style, utilisez H1/H2/H3 !</em></p>
            
            <h4>Mise en forme du texte</h4>
            <ul>
              <li><strong>Gras</strong> : S√©lectionnez le texte ‚Üí clic sur <strong>B</strong></li>
              <li><em>Italique</em> : S√©lectionnez le texte ‚Üí clic sur <em>I</em></li>
              <li><u>Soulign√©</u> : S√©lectionnez le texte ‚Üí clic sur <u>U</u></li>
              <li><span style="color: red;">Couleur</span> : S√©lectionnez le texte ‚Üí palette de couleurs</li>
              <li><span style="background-color: yellow;">Surlignage</span> : S√©lectionnez le texte ‚Üí surligneur</li>
            </ul>

            <h4>üìê Alignement</h4>
            <ul>
              <li>S√©lectionnez le paragraphe ‚Üí boutons d'alignement</li>
              <li>Gauche, centre, droite, justifi√©</li>
              <li>Pour l'arabe : direction RTL automatique</li>
            </ul>

            <h3>üñºÔ∏è M√©dias</h3>
            <p>Ins√©rer une image (syntaxe sp√©ciale) :</p>
            <pre>[IMAGE: fichier.jpg | 100% | Description facultative]
[IMAGE: fichier.jpg | 50% | Description plus petite]
[IMAGE: fichier.jpg | 25% | Miniature]</pre>
            <p>üìå Le pourcentage contr√¥le la taille (largeur/hauteur) de l'image</p>
            <p>Ins√©rer une vid√©o :</p>
            <pre>[VIDEO: video.mp4 | 100% | Description facultative]
[VIDEO: video.mp4 | 50% | Vid√©o plus petite]
[VIDEO: video.mp4 | 25% | Miniature vid√©o]</pre>
            <p>üìå Le pourcentage contr√¥le aussi la taille des vid√©os</p>

            <h3>üì¶ Blocs color√©s</h3>
            <p>Pour cr√©er un bloc avec couleur de fond :</p>
            <ol>
              <li>S√©lectionnez votre texte</li>
              <li>Clic droit ‚Üí "Inspecter l'√©l√©ment"</li>
              <li>Ajoutez : <code>style="background-color: #f0f8ff; padding: 1rem; border-radius: 5px;"</code></li>
            </ol>
            <p>Ou utilisez l'outil de fond dans la barre d'outils.</p>

            <h3>üîß Blocs avanc√©s</h3>
            <p>Timeline :</p>
            <pre>[TIMELINE]
2020 | Premier √©v√©nement
2021 | Deuxi√®me √©v√©nement
[/TIMELINE]</pre>
            <p>Citation :</p>
            <pre>[QUOTE: "Votre citation" - Auteur]</pre>

            <h3>üìù Variables dynamiques</h3>
            <p>Vous pouvez utiliser :</p>
            <ul>
              <li><code>{{book.title}}</code> ‚Äì titre du livre</li>
              <li><code>{{book.subtitle}}</code> ‚Äì sous-titre</li>
              <li><code>{{book.institution}}</code> ‚Äì institution</li>
              <li><code>{{book.years}}</code> ‚Äì ann√©es</li>
            </ul>

            <h3>üí° Conseils</h3>
            <ul>
              <li>Pour les titres de page : utilisez H1 et centrez-les</li>
              <li>Pour faire ressortir du texte : gras + couleur</li>
              <li>Pour les citations : italique + alignement centre</li>
              <li>Testez les couleurs avec parcimonie</li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Onglet Th√®me -->
      <div id="theme-panel" class="tab-panel">
        <div class="theme-editor">
          <div class="theme-form">
            <h2>üé® Personnalisation du th√®me</h2>
            <div id="themeSuccessMessage" class="success-message">
              Th√®me mis √† jour avec succ√®s !
            </div>
            
            <form id="themeForm">
              <h3>üåü Param√®tres globaux du livre</h3>
              
              <div class="form-group">
                <label for="coverEndBackgroundColor">Couleur de fond des pages COVER et FIN</label>
                <input type="color" id="coverEndBackgroundColor" name="cover_end_background_color" value="#d8e0e5">
                <div class="color-preview">
                  <div class="color-swatch" id="coverEndBackgroundSwatch"></div>
                  <span id="coverEndBackgroundHex">#d8e0e5</span>
                </div>
                <div class="notice">Cette couleur sera appliqu√©e au fond des pages de couverture et de fin</div>
              </div>

              <div class="form-group">
                <label for="globalFont">Police d'√©criture du livre</label>
                <select id="globalFont" name="global_font">
                  <option value="Poppins">Poppins</option>
                  <option value="Arial">Arial</option>
                  <option value="Helvetica">Helvetica</option>
                  <option value="Georgia">Georgia</option>
                  <option value="Times New Roman">Times New Roman</option>
                  <option value="Roboto">Roboto</option>
                  <option value="Open Sans">Open Sans</option>
                  <option value="Lato">Lato</option>
                  <option value="Montserrat">Montserrat</option>
                  <option value="Source Sans Pro">Source Sans Pro</option>
                </select>
                <div class="notice">Cette police sera utilis√©e dans tout le livre (titres et contenus)</div>
              </div>

              <div class="form-group">
                <label for="separatorColor">Couleur des traits de s√©paration des titres (pages normales)</label>
                <input type="color" id="separatorColor" name="separator_color" value="#638c1c">
                <div class="color-preview">
                  <div class="color-swatch" id="separatorSwatch"></div>
                  <span id="separatorHex">#638c1c</span>
                </div>
                <div class="notice">Couleur des lignes horizontales sous les H1 dans les pages de contenu</div>
              </div>

              <div class="form-group">
                <label for="coverEndSeparatorColor">Couleur des traits de s√©paration des titres (pages COVER/FIN)</label>
                <input type="color" id="coverEndSeparatorColor" name="cover_end_separator_color" value="#ffffff">
                <div class="color-preview">
                  <div class="color-swatch" id="coverEndSeparatorSwatch"></div>
                  <span id="coverEndSeparatorHex">#ffffff</span>
                </div>
                <div class="notice">Couleur des lignes horizontales sous les H1 dans les pages COVER et FIN</div>
              </div>

              <button type="submit" class="btn-primary">üíæ Sauvegarder le th√®me</button>
              <button type="button" class="btn-secondary" onclick="resetTheme()">üîÑ R√©initialiser</button>
            </form>
          </div>

          <div class="theme-preview">
            <h2>üîç Aper√ßu en temps r√©el</h2>
            <div class="theme-preview-content" id="themePreview">
              <div class="preview-cover-background">
                <div class="preview-title">Page COVER/FIN</div>
                <div class="preview-subtitle">Aper√ßu du fond des pages de couverture et fin</div>
              </div>
              
              <div class="preview-content-page">
                <h3 class="preview-content-title">Titre de page de contenu</h3>
                <div class="preview-separator"></div>
                <p>Contenu de page normale avec la police globale appliqu√©e.</p>
              </div>

              <div class="preview-cover-title-section">
                <h3 class="preview-cover-title">Titre de page COVER/FIN</h3>
                <div class="preview-cover-separator"></div>
                <p>Aper√ßu du trait dans les pages de couverture et fin.</p>
              </div>

              <p><strong>Police utilis√©e :</strong> <span id="previewFont">Poppins</span></p>
            </div>
          </div>
        </div>
      </div>

      <!-- Onglet M√©dias -->
      <div id="media-panel" class="tab-panel">
        <h2>üé¨ Gestion des M√©dias</h2>
        
        <!-- Zone d'upload -->
        <div class="media-upload-area">
          <div class="upload-dropzone" id="uploadDropzone">
            <div class="upload-content">
              <div class="upload-icon">üìÅ</div>
              <h3>Glissez vos m√©dias ici</h3>
              <p>ou cliquez pour s√©lectionner</p>
              <input type="file" id="mediaFileInput" accept="image/*,video/*" multiple style="display: none;">
              <button type="button" class="upload-btn" onclick="document.getElementById('mediaFileInput').click()">
                S√©lectionner des fichiers
              </button>
            </div>
          </div>
          
          <!-- Zone de progress -->
          <div class="upload-progress" id="uploadProgress" style="display: none;">
            <div class="progress-bar">
              <div class="progress-fill" id="progressFill"></div>
            </div>
            <span class="progress-text" id="progressText">0%</span>
          </div>
          
          <!-- Messages de succ√®s -->
          <div class="upload-success" id="uploadSuccess" style="display: none;">
            <div class="success-icon">‚úÖ</div>
            <div class="success-message" id="successMessage"></div>
          </div>
        </div>
        
        <!-- Statistiques -->
        <div class="media-stats">
          <div class="stat-item">
            <span class="stat-label">Total m√©dias:</span>
            <span class="stat-value" id="totalMediaCount">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Images:</span>
            <span class="stat-value" id="imageCount">0</span>
          </div>
          <div class="stat-item">
            <span class="stat-label">Vid√©os:</span>
            <span class="stat-value" id="videoCount">0</span>
          </div>
        </div>
        
        <!-- Liste des m√©dias -->
        <div class="media-grid" id="mediaGrid">
          <!-- Les m√©dias seront charg√©s dynamiquement -->
        </div>
        
        <!-- Actions en lot -->
        <div class="media-actions">
          <button type="button" class="action-btn refresh-btn" onclick="loadMediaList()">
            üîÑ Actualiser
          </button>
          <button type="button" class="action-btn clear-btn" onclick="clearSelection()">
            ‚ùå D√©s√©lectionner tout
          </button>
        </div>
      </div>

      <!-- Onglet Param√®tres -->
      <div id="settings-panel" class="tab-panel">
        <h2>‚öôÔ∏è Param√®tres du livre</h2>
        <p>Configuration des fonctionnalit√©s et du layout (√† venir)</p>
      </div>
    </div>
  </div>

  <script src="/quill/quill.min.js"></script>
  <script id="initialData">
    window.initialPage = { data: __FIRST_PAGE__, total: __TOTAL_PAGES__ };
  </script>
  <script>
    let total = 1;
    let current = 0;
    let currentType = '';
    let currentBookId = 1; // Sera d√©fini dynamiquement

    // R√©cup√©rer l'ID du livre depuis l'URL
    const urlParams = new URLSearchParams(window.location.search);
    currentBookId = urlParams.get('book') || 1;

    const quill = new Quill('#pageEditor', {
      theme: 'snow',
      modules: {
        toolbar: '#toolbar'
      }
    });
    const pageIdInput = document.getElementById('pageId');
    const pageTypeInput = document.getElementById('pageType');
    const pageTitleInput = document.getElementById('pageTitle');
    const pageNumber = document.getElementById('pageNumber');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const addBtn = document.getElementById('addBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const pageCountInput = document.getElementById('pageCount');

    // Variables pour le th√®me et les informations
    let currentTheme = {};
    let currentBookInfo = {};

    // Gestion des onglets
    function switchTab(tabName) {
      // Masquer tous les panels
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.remove('active');
      });
      
      // D√©sactiver tous les boutons
      document.querySelectorAll('.tab-button').forEach(btn => {
        btn.classList.remove('active');
      });
      
      // Activer le panel et bouton s√©lectionn√©s
      document.getElementById(tabName + '-panel').classList.add('active');
      event.target.classList.add('active');
      
      // Charger les donn√©es sp√©cifiques √† l'onglet
      if (tabName === 'info') {
        loadBookInfo();
      } else if (tabName === 'theme') {
        loadTheme();
      }
      
    }

    // Fonctions pour les informations du livre
    async function loadBookInfo() {
      try {
        const response = await fetch(`/books/${currentBookId}/info`);
        if (response.ok) {
          currentBookInfo = await response.json();
          populateBookInfoForm(currentBookInfo);
        }
      } catch (error) {
        console.error('Erreur lors du chargement des informations:', error);
      }
    }

    function populateBookInfoForm(info) {
      document.getElementById('bookTitle').value = info.title || '';
      document.getElementById('bookSubtitle').value = info.subtitle || '';
      document.getElementById('bookInstitution').value = info.institution || '';
      document.getElementById('bookAuthor').value = info.author || '';
      document.getElementById('bookYears').value = info.years || '';
      document.getElementById('bookAnniversary').value = info.anniversary || '';
      document.getElementById('bookCoverImage').value = info.cover_image || '';
      document.getElementById('bookDescription').value = info.description || '';
      document.getElementById('bookLanguage').value = info.language || 'fr';

      if (info.language === 'ar') {
        quill.root.dir = 'rtl';
        quill.root.style.textAlign = 'right';
      } else {
        quill.root.dir = 'ltr';
        quill.root.style.textAlign = '';
      }
    }

    // Fonctions du th√®me
    async function loadTheme() {
      try {
        const response = await fetch(`/books/${currentBookId}/theme`);
        if (response.ok) {
          currentTheme = await response.json();
          populateThemeForm(currentTheme);
          updateThemePreview();
        }
      } catch (error) {
        console.error('Erreur lors du chargement du th√®me:', error);
      }
    }

    function populateThemeForm(theme) {
      document.getElementById('coverEndBackgroundColor').value = theme.cover_end_background_color || '#d8e0e5';
      document.getElementById('globalFont').value = theme.global_font || 'Poppins';
      document.getElementById('separatorColor').value = theme.separator_color || '#638c1c';
      document.getElementById('coverEndSeparatorColor').value = theme.cover_end_separator_color || '#ffffff';
      
      updateColorPreviews();
    }

    function updateThemePreview() {
      const coverEndBackground = document.getElementById('coverEndBackgroundColor').value;
      const separatorColor = document.getElementById('separatorColor').value;
      const coverEndSeparatorColor = document.getElementById('coverEndSeparatorColor').value;
      const font = document.getElementById('globalFont').value;
      
      // Mettre √† jour l'aper√ßu dans l'onglet th√®me
      const preview = document.getElementById('themePreview');
      if (preview) {
        preview.style.setProperty('--cover-end-background-color', coverEndBackground);
        preview.style.setProperty('--separator-color', separatorColor);
        preview.style.setProperty('--cover-end-separator-color', coverEndSeparatorColor);
        preview.style.setProperty('--global-font', font);
        
        // Appliquer la police √† tout l'aper√ßu
        preview.style.fontFamily = `'${font}', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif`;
        
        // Mettre √† jour l'affichage de la police
        const previewFont = document.getElementById('previewFont');
        if (previewFont) {
          previewFont.textContent = font;
        }
        
        // Mettre √† jour le style de l'aper√ßu COVER/FIN
        const coverBackground = preview.querySelector('.preview-cover-background');
        if (coverBackground) {
          coverBackground.style.backgroundColor = coverEndBackground;
        }
        
        // Mettre √† jour le style du s√©parateur de contenu
        const separator = preview.querySelector('.preview-separator');
        if (separator) {
          separator.style.backgroundColor = separatorColor;
        }
        
        // Mettre √† jour le style du s√©parateur COVER/FIN
        const coverSeparator = preview.querySelector('.preview-cover-separator');
        if (coverSeparator) {
          coverSeparator.style.backgroundColor = coverEndSeparatorColor;
        }
      }
    }

    function lightenColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) + amt;
      const G = (num >> 8 & 0x00FF) + amt;
      const B = (num & 0x0000FF) + amt;
      return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 + 
        (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 + 
        (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
    }

    function darkenColor(color, percent) {
      const num = parseInt(color.replace("#", ""), 16);
      const amt = Math.round(2.55 * percent);
      const R = (num >> 16) - amt;
      const G = (num >> 8 & 0x00FF) - amt;
      const B = (num & 0x0000FF) - amt;
      return "#" + (0x1000000 + (R > 255 ? 255 : R < 0 ? 0 : R) * 0x10000 + 
        (G > 255 ? 255 : G < 0 ? 0 : G) * 0x100 + 
        (B > 255 ? 255 : B < 0 ? 0 : B)).toString(16).slice(1);
    }

    function resetTheme() {
      document.getElementById('coverEndBackgroundColor').value = '#d8e0e5';
      document.getElementById('globalFont').value = 'Poppins';
      document.getElementById('separatorColor').value = '#638c1c';
      document.getElementById('coverEndSeparatorColor').value = '#ffffff';
      
      updateColorPreviews();
      updateThemePreview();
    }

    // Mise √† jour des aper√ßus de couleurs pour les nouveaux champs
    function updateColorPreviews() {
      const colors = [
        { input: 'coverEndBackgroundColor', swatch: 'coverEndBackgroundSwatch', hex: 'coverEndBackgroundHex' },
        { input: 'separatorColor', swatch: 'separatorSwatch', hex: 'separatorHex' },
        { input: 'coverEndSeparatorColor', swatch: 'coverEndSeparatorSwatch', hex: 'coverEndSeparatorHex' }
      ];
      
      colors.forEach(color => {
        const value = document.getElementById(color.input).value;
        document.getElementById(color.swatch).style.backgroundColor = value;
        document.getElementById(color.hex).textContent = value;
      });
    }

    // Event listeners pour le th√®me
    document.getElementById('themeForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const themeData = {
        cover_end_background_color: document.getElementById('coverEndBackgroundColor').value,
        global_font: document.getElementById('globalFont').value,
        separator_color: document.getElementById('separatorColor').value,
        cover_end_separator_color: document.getElementById('coverEndSeparatorColor').value
      };
      
      try {
        const response = await fetch(`/books/${currentBookId}/theme`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(themeData)
        });
        
        if (response.ok) {
          const successMsg = document.getElementById('themeSuccessMessage');
          successMsg.style.display = 'block';
          setTimeout(() => {
            successMsg.style.display = 'none';
          }, 3000);
        } else {
          alert('Erreur lors de la sauvegarde du th√®me');
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde du th√®me');
      }
    });

    // Event listeners pour les nouveaux champs de th√®me
    document.getElementById('coverEndBackgroundColor').addEventListener('input', () => {
      updateColorPreviews();
      updateThemePreview();
    });

    document.getElementById('separatorColor').addEventListener('input', () => {
      updateColorPreviews();
      updateThemePreview();
    });

    document.getElementById('coverEndSeparatorColor').addEventListener('input', () => {
      updateColorPreviews();
      updateThemePreview();
    });

    document.getElementById('globalFont').addEventListener('change', updateThemePreview);

    // Event listener pour les informations du livre
    document.getElementById('infoForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const infoData = {
        title: document.getElementById('bookTitle').value,
        subtitle: document.getElementById('bookSubtitle').value,
        institution: document.getElementById('bookInstitution').value,
        author: document.getElementById('bookAuthor').value,
        years: document.getElementById('bookYears').value,
        anniversary: document.getElementById('bookAnniversary').value,
        cover_image: document.getElementById('bookCoverImage').value,
        description: document.getElementById('bookDescription').value,
        language: document.getElementById('bookLanguage').value
      };
      
      try {
        const response = await fetch(`/books/${currentBookId}/info`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(infoData)
        });
        
        if (response.ok) {
          const successMsg = document.getElementById('infoSuccessMessage');
          successMsg.style.display = 'block';
          setTimeout(() => {
            successMsg.style.display = 'none';
          }, 3000);
          
          // Mettre √† jour le titre de la page si modifi√©
          if (infoData.title) {
            document.title = `√âditeur - ${infoData.title}`;
          }
        } else {
          alert('Erreur lors de la sauvegarde des informations');
        }
      } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors de la sauvegarde des informations');
      }
    });

    function getEditorHtml() {
      return quill.root.innerHTML;
    }

    function setEditorHtml(html) {
      quill.clipboard.dangerouslyPasteHTML(html || '');
    }



    if (window.initialPage) {
      const p = window.initialPage.data || {};
      setEditorHtml(p.content || '');
      pageIdInput.value = p.id || '';
      pageTypeInput.value = p.type || '';
      pageTitleInput.value = p.title || '';
      total = window.initialPage.total || 1;
      current = 0;
      currentType = p.type || '';
    }

    function updateIndicator() {
      pageNumber.textContent = `Page ${current + 1} / ${total}`;
      prevBtn.disabled = current === 0;
      nextBtn.disabled = current === total - 1;
      addBtn.disabled = current === total - 1 || currentType === 'end';
      deleteBtn.disabled = !canDeleteCurrentPage();
      pageCountInput.value = total;
    }

    function canDeleteCurrentPage() {
      // Cannot delete if only one page
      if (total <= 1) return false;
      
      // Cannot delete cover page
      if (currentType === 'cover') return false;
      
      // Cannot delete end page
      if (currentType === 'end') return false;
      
      // Cannot delete if current page is first (index 0) - typically cover
      if (current === 0) return false;
      
      // Cannot delete if current page is last (index total-1) - typically end
      if (current === total - 1) return false;
      
      return true;
    }

    async function loadPage(idx) {
      const res = await fetch(`/pages/${idx}?book=${currentBookId}`);
      const data = await res.json();
      setEditorHtml(data.content || '');
      pageIdInput.value = data.id || '';
      pageTypeInput.value = data.type || '';
      pageTitleInput.value = data.title || '';
      total = data.total;
      current = idx;
      currentType = data.type || '';
      updateIndicator();
    }

    async function savePage(idx) {
      // Sauvegarder le contenu et le titre
      const content = getEditorHtml();
      const title = document.getElementById('pageTitle').value;
      console.log('üíæ Sauvegarde page', idx, 'Titre:', title, 'Contenu:', content.substring(0, 100) + '...');
      
      // Pr√©parer les donn√©es √† envoyer
      const pageData = {
        title: title,
        content: content
      };
      
      const response = await fetch(`/pages/${idx}?book=${currentBookId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(pageData)
      });
      
      if (response.ok) {
        console.log('‚úÖ Page sauvegard√©e avec succ√®s');
        // Indicator visuel de sauvegarde
        const saveBtn = document.getElementById('saveBtn');
        if (saveBtn) {
          const originalText = saveBtn.textContent;
          saveBtn.textContent = '‚úÖ Sauvegard√©';
          saveBtn.style.background = '#28a745';
          setTimeout(() => {
            saveBtn.textContent = originalText;
            saveBtn.style.background = '#28a745';
          }, 2000);
        }
      } else {
        console.error('‚ùå Erreur lors de la sauvegarde:', response.status);
        alert('Erreur lors de la sauvegarde');
      }
    }

    updateIndicator();
    loadPage(0);
    
    // Charger les informations du livre au d√©marrage
    loadBookInfo();

    prevBtn.addEventListener('click', async () => {
      await savePage(current);
      await loadPage(current - 1);
    });

    nextBtn.addEventListener('click', async () => {
      await savePage(current);
      await loadPage(current + 1);
    });

    addBtn.addEventListener('click', async () => {
      // Sauvegarder la page courante d'abord
      await savePage(current);
      
      // V√©rifier quelles options sont disponibles
      const res = await fetch(`/pages/types?book=${currentBookId}`);
      if (!res.ok) {
        alert('Erreur lors de la v√©rification des types disponibles');
        return;
      }
      
      const typeData = await res.json();
      let selectedType = 'content'; // Par d√©faut
      
      // Si SOMMAIRE est disponible, demander √† l'utilisateur
      if (!typeData.hasSommaire) {
        // V√©rifier si on peut ins√©rer SOMMAIRE √† cette position (seulement apr√®s COVER)
        if (current === 0) { // Apr√®s la page 0 (COVER)
          const choice = confirm("Voulez-vous cr√©er une page SOMMAIRE ?\n\nOK = SOMMAIRE\nAnnuler = PAGE DE CONTENU");
          selectedType = choice ? 'sommaire' : 'content';
        } else {
          // Si on n'est pas apr√®s COVER, on ne peut cr√©er que CONTENT
          selectedType = 'content';
        }
      }
      
      // D√©terminer le contenu selon le type
      let title, content;
      if (selectedType === 'sommaire') {
        title = 'SOMMAIRE';
        content = '# SOMMAIRE\n\n## Table des mati√®res\n\nCe sommaire est g√©n√©r√© automatiquement en fonction des pages de contenu de votre livre.\n\n<!-- Les liens vers les pages sont g√©n√©r√©s automatiquement -->';
      } else {
        title = 'Nouvelle page';
        content = '# Nouvelle page\n\nContenu de votre page...';
      }
      
      const newPageData = { type: selectedType, title, content };
      
      const insertRes = await fetch(`/pages/${current}/insert?book=${currentBookId}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(newPageData)
      });
      
      if (insertRes.ok) {
        const data = await insertRes.json();
        total = data.total;
        await loadPage(data.index);
      } else {
        const errorText = await insertRes.text();
        alert('Insertion √©chou√©e: ' + errorText);
      }
    });

    deleteBtn.addEventListener('click', async () => {
      if (!canDeleteCurrentPage()) {
        alert('Cette page ne peut pas √™tre supprim√©e.');
        return;
      }

      const confirmMessage = `√ätes-vous s√ªr de vouloir supprimer la page ${current + 1} ? Cette action est irr√©versible.`;
      if (!confirm(confirmMessage)) {
        return;
      }

      try {
        const res = await fetch(`/pages/${current}?book=${currentBookId}`, {
          method: 'DELETE'
        });

        if (res.ok) {
          const data = await res.json();
          total = data.total;
          
          // Move to previous page if current becomes out of bounds
          const newIndex = current >= total ? total - 1 : current;
          await loadPage(newIndex);
          
          alert('Page supprim√©e avec succ√®s');
        } else {
          const errorData = await res.json();
          alert('Erreur lors de la suppression: ' + (errorData.error || 'Erreur inconnue'));
        }
      } catch (error) {
        console.error('Erreur lors de la suppression:', error);
        alert('Erreur lors de la suppression de la page');
      }
    });

    // Event listener pour le bouton sauvegarder
    document.getElementById('saveBtn').addEventListener('click', async () => {
      await savePage(current);
    });

    // Sauvegarde automatique sur changement du contenu (avec debounce)
    let saveTimeout;
    quill.on('text-change', () => {
      clearTimeout(saveTimeout);
      saveTimeout = setTimeout(() => {
        savePage(current);
      }, 2000); // Sauvegarde apr√®s 2 secondes d'inactivit√©
    });

    document.getElementById('editorForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      await savePage(current);
      const text = await fetch(`/editor?raw=1&book=${currentBookId}`).then(r => r.text());
      const sections = text ? text.split('\n---\n') : [''];
      pageCountInput.value = sections.length;
      const form = document.getElementById('editorForm');
      form.querySelectorAll('.hiddenPage').forEach(e => e.remove());
      sections.forEach((content, i) => {
        const t = document.createElement('textarea');
        t.name = `page${i}`;
        t.textContent = content;
        t.style.display = 'none';
        t.className = 'hiddenPage';
        form.appendChild(t);
      });
      
      // Ajouter le param√®tre book √† l'action du formulaire
      form.action = `/editor?book=${currentBookId}`;
      form.submit();
    });

    document.getElementById('buildBtn').addEventListener('click', async () => {
      try {
        const res = await fetch(`/build?book=${currentBookId}`, { 
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            generatorType: 'rtl'
          })
        });
        const msg = await res.text();
        alert(msg);
      } catch (err) {
        alert('Build failed');
      }
    });

    // Ouvrir un nouvel onglet pour pr√©visualiser le livre g√©n√©r√©
    document.getElementById('viewBtn').addEventListener('click', () => {
      window.open(`/books/${currentBookId}/preview?type=rtl`, '_blank');
    });

    // Fonction de d√©connexion
    async function logout() {
      if (confirm('√ätes-vous s√ªr de vouloir vous d√©connecter ?')) {
        try {
          const response = await fetch('/logout', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            }
          });

          if (response.ok) {
            window.location.href = '/login';
          } else {
            alert('Erreur lors de la d√©connexion');
          }
        } catch (error) {
          console.error('Erreur:', error);
          alert('Erreur lors de la d√©connexion');
        }
      }
    }

    // Note: Upload de m√©dias d√©plac√© vers l'onglet M√©dias d√©di√©

    // ========== GESTION DES M√âDIAS ==========
    
    let mediaList = [];
    
    // Formater la taille des fichiers
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }
    
    // Charger la liste des m√©dias pour le livre actuel
    async function loadMediaList() {
      try {
        console.log('üîç DEBUG: currentBookId =', currentBookId);
        console.log('üîç DEBUG: URL compl√®te =', window.location.href);
        
        const response = await fetch(`/media?book=${currentBookId}`);
        console.log('üîç DEBUG: Response status =', response.status);
        
        if (response.ok) {
          mediaList = await response.json();
          console.log('üîç DEBUG: M√©dias re√ßus =', mediaList);
          updateMediaStats();
          renderMediaGrid();
        } else {
          const errorText = await response.text();
          console.error('‚ùå Erreur r√©ponse serveur:', response.status, errorText);
          alert(`Erreur lors du chargement des m√©dias: ${response.status} - ${errorText}`);
        }
      } catch (error) {
        console.error('‚ùå Erreur r√©seau:', error);
        alert(`Erreur r√©seau: ${error.message}`);
      }
    }
    
    // Mettre √† jour les statistiques
    function updateMediaStats() {
      const totalCount = mediaList.length;
      const imageCount = mediaList.filter(media => media.type === 'image').length;
      const videoCount = mediaList.filter(media => media.type === 'video').length;
      
      document.getElementById('totalMediaCount').textContent = totalCount;
      document.getElementById('imageCount').textContent = imageCount;
      document.getElementById('videoCount').textContent = videoCount;
    }
    
    // Rendre la grille des m√©dias
    function renderMediaGrid() {
      const grid = document.getElementById('mediaGrid');
      
      if (mediaList.length === 0) {
        grid.innerHTML = '<div class="media-empty">Aucun m√©dia upload√©</div>';
        return;
      }
      
      grid.innerHTML = mediaList.map(media => `
        <div class="media-item" data-filename="${media.filename}">
          <div class="media-preview">
            ${media.type === 'image' 
              ? `<img src="${media.url}" alt="${media.filename}" loading="lazy">`
              : `<div class="video-preview">
                   <video preload="none" muted>
                     <source src="${media.url}" type="video/mp4">
                   </video>
                   <div class="video-overlay">üé¨</div>
                 </div>`
            }
          </div>
          <div class="media-info">
            <div class="media-filename">${media.filename}</div>
            <div class="media-original" style="font-size: 0.8rem; color: #888; font-style: italic;">
              ${media.originalName ? `Original: ${media.originalName}` : ''}
            </div>
            <div class="media-meta">Type: ${media.type.toUpperCase()}</div>
            <div class="media-size" style="font-size: 0.8rem; color: #666;">${formatFileSize(media.size)}</div>
          </div>
          <div class="media-actions">
            <button type="button" class="action-btn copy-btn" onclick="copyMediaReference('${media.filename}')" title="Copier la r√©f√©rence">
              üìã
            </button>
            <button type="button" class="action-btn view-btn" onclick="viewMedia('${media.filename}', '${media.url}')" title="Voir en grand">
              üëÅÔ∏è
            </button>
            <button type="button" class="action-btn delete-btn" onclick="deleteMedia('${media.filename}')" title="Supprimer">
              üóëÔ∏è
            </button>
          </div>
        </div>
      `).join('');
    }
    
    // Copier la r√©f√©rence d'un m√©dia
    function copyMediaReference(filename) {
      const extension = filename.split('.').pop().toLowerCase();
      const reference = extension === 'mp4' || extension === 'mov' || extension === 'avi' 
        ? `[VIDEO: ${filename} | 100% | Description]`
        : `[IMAGE: ${filename} | 100% | Description]`;
      
      navigator.clipboard.writeText(reference).then(() => {
        showMediaSuccess(`R√©f√©rence copi√©e: ${reference}`);
      }).catch(() => {
        // Fallback pour les navigateurs anciens
        const textArea = document.createElement('textarea');
        textArea.value = reference;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        showMediaSuccess(`R√©f√©rence copi√©e: ${reference}`);
      });
    }
    
    // Voir un m√©dia en grand
    function viewMedia(filename, url) {
      const media = mediaList.find(m => m.filename === filename);
      if (!media) return;
      
      const modal = document.createElement('div');
      modal.className = 'media-modal';
      modal.innerHTML = `
        <div class="media-modal-content">
          <div class="media-modal-header">
            <h3>${filename}</h3>
            <button onclick="this.closest('.media-modal').remove()">√ó</button>
          </div>
          <div class="media-modal-body">
            ${media.type === 'image'
              ? `<img src="${url}" alt="${filename}">`
              : `<video src="${url}" controls></video>`
            }
          </div>
        </div>
      `;
      
      modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
      });
      
      document.body.appendChild(modal);
    }
    
    // Supprimer un m√©dia
    async function deleteMedia(filename) {
      if (confirm(`√ätes-vous s√ªr de vouloir supprimer ${filename} ?\n\nCette action est irr√©versible.`)) {
        try {
          const response = await fetch(`/media/${filename}?book=${currentBookId}`, {
            method: 'DELETE'
          });
          
          if (response.ok) {
            const result = await response.json();
            showMediaSuccess(`${filename} supprim√© avec succ√®s`);
            
            // Recharger la liste des m√©dias
            loadMediaList();
          } else {
            const error = await response.json();
            alert(`Erreur lors de la suppression: ${error.error || 'Erreur inconnue'}`);
          }
        } catch (error) {
          console.error('Erreur lors de la suppression:', error);
          alert('Erreur lors de la suppression du m√©dia');
        }
      }
    }
    
    // Afficher un message de succ√®s
    function showMediaSuccess(message) {
      const successDiv = document.getElementById('uploadSuccess');
      const messageDiv = document.getElementById('successMessage');
      
      messageDiv.textContent = message;
      successDiv.style.display = 'block';
      
      setTimeout(() => {
        successDiv.style.display = 'none';
      }, 3000);
    }
    
    // D√©s√©lectionner tous les m√©dias
    function clearSelection() {
      document.querySelectorAll('.media-item.selected').forEach(item => {
        item.classList.remove('selected');
      });
    }
    
    // Gestion de l'upload par drag & drop
    const dropzone = document.getElementById('uploadDropzone');
    const fileInput = document.getElementById('mediaFileInput');
    
    if (dropzone && fileInput) {
      // Drag & Drop
      dropzone.addEventListener('dragover', (e) => {
        e.preventDefault();
        dropzone.classList.add('dragover');
      });
      
      dropzone.addEventListener('dragleave', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
      });
      
      dropzone.addEventListener('drop', (e) => {
        e.preventDefault();
        dropzone.classList.remove('dragover');
        
        const files = Array.from(e.dataTransfer.files);
        uploadMediaFiles(files);
      });
      
      // Upload via input
      fileInput.addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        uploadMediaFiles(files);
        e.target.value = ''; // Reset input
      });
    }
    
    // Upload des fichiers m√©dia
    async function uploadMediaFiles(files) {
      if (!files || files.length === 0) return;
      
      console.log('üîç DEBUG UPLOAD: currentBookId =', currentBookId);
      console.log('üîç DEBUG UPLOAD: Nombre de fichiers =', files.length);
      console.log('üîç DEBUG UPLOAD: Fichiers =', Array.from(files).map(f => f.name));
      
      const formData = new FormData();
      files.forEach(file => formData.append('media', file));
      
      // Afficher la progression
      const progressDiv = document.getElementById('uploadProgress');
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressDiv.style.display = 'block';
      progressFill.style.width = '0%';
      progressText.textContent = '0%';
      
      try {
        console.log('üîç DEBUG UPLOAD: Envoi vers /editor?book=' + currentBookId);
        const response = await fetch(`/editor?book=${currentBookId}`, {
          method: 'POST',
          body: formData
        });
        
        console.log('üîç DEBUG UPLOAD: Response status =', response.status);
        
        // Simulation de progression (car fetch ne supporte pas le progress natif)
        let progress = 0;
        const progressInterval = setInterval(() => {
          progress += 10;
          if (progress <= 90) {
            progressFill.style.width = progress + '%';
            progressText.textContent = progress + '%';
          }
        }, 100);
        
        if (response.ok) {
          const result = await response.json();
          
          // Finaliser la progression
          clearInterval(progressInterval);
          progressFill.style.width = '100%';
          progressText.textContent = '100%';
          
          setTimeout(() => {
            progressDiv.style.display = 'none';
            
            // Afficher le message de succ√®s
            const fileNames = result.files.map(f => `${f.originalName} ‚Üí ${f.savedAs}`).join(', ');
            showMediaSuccess(`${result.files.length} fichier(s) upload√©(s): ${fileNames}`);
            
            // Recharger la liste des m√©dias
            loadMediaList();
          }, 500);
          
        } else {
          clearInterval(progressInterval);
          progressDiv.style.display = 'none';
          alert('Erreur lors de l\'upload');
        }
        
      } catch (error) {
        console.error('Erreur upload:', error);
        progressDiv.style.display = 'none';
        alert('Erreur lors de l\'upload');
      }
    }
    
    // Charger les m√©dias si on est sur l'onglet m√©dia
    document.addEventListener('DOMContentLoaded', () => {
      if (typeof switchTab === 'function') {
        const originalSwitchTab = switchTab;
        switchTab = function(tabName) {
          originalSwitchTab(tabName);
          if (tabName === 'media') {
            loadMediaList();
          }
        };
      };
    });
  </script>
</body>
</html>